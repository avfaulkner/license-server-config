---
# Update the OSs and reboot them
- name: Update the OS
  package:
    name: "*"
    state: latest

#- name: Reboot after updates
#  shell: "sleep 5 && reboot"
#  async: 1
#  poll: 0

# Reboot Ubuntu if required after updates
- name: Check if a reboot is required - Ubuntu
  register: reboot_required_file
  stat: path=/var/run/reboot-required get_md5=no
#  wnen: ansible_distribution == "Ubuntu"

- name: Reboot Ubuntu
  reboot:
    msg: "Reboot due to updates"
    connect_timeout: 5
    reboot_timeout: 300
    pre_reboot_delay: 0
    post_reboot_delay: 30
    test_command: uptime
  when: reboot_required_file.stat.exists && ansible_distribution == "Ubuntu"

# Reboot CentOS if required due to updates
- name: Check if a reboot is required - CentOS
  register: reboot_required_file
  stat: path=/var/run/reboot-required get_md5=no
  when: ansible_distribution == "CentOS"






- name: Wait for 10 seconds for system startup
  pause:
    seconds: 10

- name: Wait for instance reboot
  wait_for_connection:
    connect_timeout: 20
    sleep: 5
    delay: 5
    timeout: 60
